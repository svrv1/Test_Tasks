ВЫБРАТЬ
	ПриобретениеТоваровУслуг.Ссылка КАК Ссылка,
	ПриобретениеТоваровУслуг.Дата КАК Дата,
	ПриобретениеТоваровУслуг.Валюта КАК Валюта
ПОМЕСТИТЬ ВТ_Документы
ИЗ
	Документ.ПриобретениеТоваровУслуг КАК ПриобретениеТоваровУслуг
ГДЕ
	ПриобретениеТоваровУслуг.Валюта = &Валюта
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_Документы.Ссылка КАК Ссылка,
	ВТ_Документы.Дата КАК Дата,
	ВТ_Документы.Валюта КАК Валюта,
	КурсыВалют.Период КАК ДатаКурса
ПОМЕСТИТЬ ВТ_Курсы
ИЗ
	ВТ_Документы КАК ВТ_Документы
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют КАК КурсыВалют
		ПО (КурсыВалют.Период <= ВТ_Документы.Дата)
			И (КурсыВалют.Валюта = ВТ_Документы.Валюта)
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_Курсы.Ссылка КАК Ссылка,
	ВТ_Курсы.Дата КАК Дата,
	ВТ_Курсы.Валюта КАК Валюта,
	МАКСИМУМ(ВТ_Курсы.ДатаКурса) КАК ДатаКурса
ПОМЕСТИТЬ ВТ_КурсыМаксимум
ИЗ
	ВТ_Курсы КАК ВТ_Курсы

СГРУППИРОВАТЬ ПО
	ВТ_Курсы.Дата,
	ВТ_Курсы.Валюта,
	ВТ_Курсы.Ссылка
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_КурсыМаксимум.Ссылка КАК Документ,
	ВТ_КурсыМаксимум.Дата КАК Дата,
	ВТ_КурсыМаксимум.Валюта КАК Валюта,
	ВТ_КурсыМаксимум.ДатаКурса КАК ДатаКурса,
	КурсыВалют.Курс КАК КурсВалютыНаДату
ИЗ
	ВТ_КурсыМаксимум КАК ВТ_КурсыМаксимум
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют КАК КурсыВалют
		ПО (КурсыВалют.Валюта = ВТ_КурсыМаксимум.Валюта)
			И (КурсыВалют.Период = ВТ_КурсыМаксимум.ДатаКурса)

УПОРЯДОЧИТЬ ПО
	Дата
